<div class="dashboard-container">

  <div class="dashboard-header">
    <!-- Profile Summary -->
    <div class="profile">
      <% avatar_url = current_user.facebook_picture_url || current_user.photo %>
      <%= cl_image_tag avatar_url, class: "dashboard-photo" %>
      <h4>
        <%= @user.first_name.upcase %> <%= @user.last_name.upcase %> &nbsp
        <%= link_to edit_user_registration_path do %>
          <i class="fa fa-pencil" aria-hidden="true"></i>
        <% end %>
      </h4>
      <p>
        Member since <%= @user.created_at.strftime("%B %Y") %>
        <% if @user.location? %>
          &nbsp | &nbsp <%= @user.location %>
        <% end %>
      </p>
    </div>

    <!-- Logic #1 -->
    <% all_runs = [] %>
    <% @user.runs.each do |run| %>
      <% all_runs << run %>
    <% end %>
    <% @user.bookings.each do |booking| %>
      <% all_runs << booking.run %>
    <% end %>

    <!-- Logic #2 -->
    <% hosting_count = 0 %>
    <% hosted_count = 0 %>
    <% @user.runs.each do |run| %>
      <% if run.date > Date.today - 1 %>
        <% hosting_count += 1 %>
      <% else %>
        <% hosted_count += 1 %>
      <% end %>
    <% end %>

    <% upcoming_count = 0 %>
    <% past_count = 0 %>
    <% @user.bookings.each do |booking| %>
      <% if booking.run.date > Date.today - 1 %>
        <% upcoming_count += 1 %>
      <% else %>
        <% past_count += 1 %>
      <% end %>
    <% end %>

    <!-- Stats -->
    <div class="stats">
      <!-- Hosted Runs -->
      <div class="stat">
        <h3><%= hosted_count %></h3>
        <h4><%= hosted_count == 1 ? "RUN" : "RUNS" %> HOSTED</h4>
      </div>

      <!-- Total Distance -->
      <div class="stat">
        <% distance_sum = 0 %>
        <% all_runs.each do |run| %>
          <% if run.date <= Date.today - 1 %>
            <% distance_sum += run.run_distance %>
          <% end %>
        <% end %>
        <h3><%= number_with_delimiter(distance_sum) %></h3>
        <h4><%= distance_sum == 1 ? "KILOMETRE" : "KILOMETRES" %> RUN</h4>
      </div>

      <!-- Total Time -->
      <div class="stat">
        <% time_sum = 0 %>
        <% all_runs.each do |run| %>
          <% if run.date <= Date.today - 1 %>
            <% if run.pace.nil? %>
              <% time_calc = 0 %>
            <% else %>
              <% time_calc = run.run_distance.to_i % run.pace.to_i %>
            <% end %>
          <% end %>
          <% time_sum += time_calc.to_i %>
        <% end %>
        <h3><%= number_with_delimiter(time_sum) %></h3>
        <h4><%= time_sum == 1 ? "MINUTE" : "MINUTES" %> TRAINED</h4>
      </div>
    </div>
  </div>

  <!-- Run History -->
  <div class="history breather">
    <h3>RUN HISTORY</h3>
    <!-- Tabs -->
    <div class="tabs">
      <a href="#" class="tab" id="all-tab" >ALL (<%= all_runs.count.to_i %>)</a>
      <a href="#" class="tab" id="hosting-tab">HOSTING (<%= hosting_count %>)</a>
      <a href="#" class="tab" id="hosted-tab">HOSTED (<%= hosted_count %>)</a>
      <a href="#" class="tab" id="upcoming-tab">UPCOMING (<%= upcoming_count %>)</a>
      <a href="#" class="tab" id="past-tab">PAST (<%= past_count %>)</a>
    </div>

    <div class="logs">
      <!-- All Runs -->
      <div class="non-host-runs content-filter" id="all-runs">
        <% if all_runs.any? %>
          <ul class="log">
            <% all_runs.each do |run| %>
              <li class="flex">

                <div class="log-left display-block">
                  <% if run.user == current_user %>
                    <h5>HOST: YOU</h5>
                  <% else %>
                    <h5>HOST: <%= run.user.first_name.upcase %> <%= run.user.last_name.upcase %></h5>
                  <% end %>
                  <p>CONFIRMED RUNNERS: <%= run.bookings.count %></p>
                </div>
                <div class="log-middle">
                  <h5><%= run.title.split.map {|r| r.upcase}.join(" ") %></h5>
                  <p><%= run.location.upcase.match(/^(.+?),/).to_s %> <%= run.location.upcase.match(/,\s*([^,]+)$/).to_s.gsub(", ","") %></p>
                </div>
                <div class="log-right">
                  <p><%= run.date.strftime("%b %d %Y").upcase %></p>
                  <p><%= run.time.strftime("%l:%M %p") %></p>
                </div>
                <%= link_to "", run_path(run), class: "flex-link" %>
              </li>
            <% end %>
          </ul>
          <% else %>
            <div class="log no-runs">
              <p>You haven't hosted/scheduled any runs yet. Would you like to schedule a run?</p>
            </div>
          <% end %>
        </div>
      <!-- Hosting Runs -->
      <div class="host-runs content-filter hidden" id="hosting-runs">
        <% if @user.runs.any? { |r| r.date >= Date.today } %>
          <ul class="log">
            <% @user.runs.each do |run| %>
              <% if run.date > Date.today - 1 %>
                <li class="flex" data-run-id="<%= run.id %>">
                  <div class="log-left">
                    <p>CONFIRMED RUNNERS: <%= run.bookings.count %></p>
                    <ul class="list-inline">
                      <li>
                        <%= link_to run_messages_path(run) do %>
                          <p><i class="fa fa-envelope" aria-hidden="true"></i></p>
                        <% end %>
                      </li>
                      <li>
                        <%= link_to edit_run_path(run) do %>
                          <p><i class="fa fa-pencil" aria-hidden="true"></i></p>
                        <% end %>
                      </li>
                      <li>
                        <%= link_to run_path(run), method: :delete, remote: true do %>
                          <p><i class="fa fa-trash" aria-hidden="true"></i></p>
                        <% end %>
                      </li>
                    </ul>
                  </div>
                  <div class="log-middle">
                    <h5><%= run.title.split.map {|r| r.upcase}.join(" ") %></h5>
                    <p><%= run.location.upcase.match(/^(.+?),/).to_s %> <%= run.location.upcase.match(/,\s*([^,]+)$/).to_s.gsub(", ","") %></p>
                  </div>
                  <div class="log-right">
                    <p><%= run.date.strftime("%b %d %Y").upcase %></p>
                    <p><%= run.time.strftime("%l:%M %p") %></p>
                  </div>
                </li>
              <% end %>
            <% end %>
          </ul>
        <% else %>
          <div class="log no-runs">
            <p>You're not hosting any runs in the future yet. Do you want to host a run?</p>
          </div>
        <% end %>
      </div>
      <!-- Hosted Runs -->
      <div class="host-runs content-filter hidden" id="hosted-runs">
        <% unless @user.runs.empty? %>
          <ul class="log">
            <% @user.runs.each do |run| %>
              <% if run.date <= Date.today - 1 %>
                <li class="flex">
                  <div class="log-left">
                    <p>CONFIRMED RUNNERS: <%= run.bookings.count %></p>
                  </div>
                  <div class="log-middle">
                    <h5><%= run.title.split.map {|r| r.upcase}.join(" ") %></h5>
                    <p><%= run.location.upcase.match(/^(.+?),/).to_s %> <%= run.location.upcase.match(/,\s*([^,]+)$/).to_s.gsub(", ","") %></p>
                  </div>
                  <div class="log-right">
                    <p><%= run.date.strftime("%b %d %Y").upcase %></p>
                    <p><%= run.time.strftime("%l:%M %p") %></p>
                  </div>
                </li>
              <% end %>
            <% end %>
          </ul>
        <% else %>
          <div class="log no-runs">
            <p>You haven't hosted any runs before</p>
          </div>
        <% end %>
      </div>
      <!-- Upcoming Runs -->
      <div class="non-host-runs content-filter hidden" id="upcoming-runs">
        <% if upcoming_count >= 1 %>
          <ul class="log">
            <% @user.bookings.each do |booking| %>
              <% if booking.run.date > Date.today - 1 %>
                <li class="flex" data-booking-id="<%= booking.id %>">
                  <div class="log-left">
                    <div class="left-photo">
                      <%= cl_image_tag booking.run.user.photo, class: "history-photo" %>
                    </div>
                    <div class="left-info">
                      <h5><%= booking.run.user.first_name.upcase %> <%= booking.run.user.last_name.upcase %></h5>
                      <ul class="list-inline">
                        <li>
                          <%= link_to run_messages_path(booking.run) do %>
                            <p><i class="fa fa-envelope" aria-hidden="true"></i></p>
                          <% end %>
                        </li>
                        <li>
                          <%= link_to booking_path(booking), method: :delete, remote: true do %>
                            <p><i class="fa fa-trash" aria-hidden="true"></i></p>
                          <% end %>
                        </li>
                      </ul>
                    </div>
                  </div>
                  <div class="log-middle">
                    <h5><%= booking.run.title.split.map {|r| r.upcase}.join(" ") %></h5>
                    <p><%= booking.run.location.upcase.match(/^(.+?),/).to_s %> <%= booking.run.location.upcase.match(/,\s*([^,]+)$/).to_s.gsub(", ","") %></p>
                  </div>
                  <div class="log-right">
                    <p><%= booking.run.date.strftime("%b %d %Y").upcase %></p>
                    <p><%= booking.run.time.strftime("%l:%M %p") %></p>
                  </div>
                </li>
              <% end %>
            <% end %>
          </ul>
        <% else %>
          <div class="log no-runs">
            <p><%= link_to "You don't have any upcoming runs. Would you like to schedule a run?", runs_path %></p>
          </div>
        <% end %>
      </div>
      <!-- Past Runs -->
      <div class="non-host-runs content-filter hidden" id="past-runs">
        <% if @user.bookings.any? { |b| b.run.date < Date.today } %>
          <ul class="log">
            <% @user.bookings.each do |booking| %>
              <% if booking.run.date < Date.today %>
                <li class="flex">
                  <div class="log-left">
                    <div class="left-photo">
                      <%= cl_image_tag booking.run.user.photo, class: "history-photo" %>
                    </div>
                    <div class="left-info">
                      <h5><%= booking.run.user.first_name.upcase %> <%= booking.run.user.last_name.upcase %></h5>
                    </div>
                  </div>
                  <div class="log-middle">
                    <h5><%= booking.run.title.split.map {|r| r.upcase}.join(" ") %></h5>
                    <p><%= booking.run.location.upcase.match(/^(.+?),/).to_s %> <%= booking.run.location.upcase.match(/,\s*([^,]+)$/).to_s.gsub(", ","") %></p>
                  </div>
                  <div class="log-right">
                    <p><%= booking.run.date.strftime("%b %d %Y").upcase %></p>
                    <p><%= booking.run.time.strftime("%l:%M %p") %></p>
                  </div>
                </li>
              <% end %>
            <% end %>
          </ul>
        <% else %>
          <div class="log no-runs">
            <p>You haven't scheduled any runs before.</p>
          </div>
        <% end %>
      </div>
    </div>
  </div>

  <!-- Achievements -->
  <div class="achievements breather">
    <h3>ACHIEVEMENTS</h3>
    <div class="achievements-flex">
      <!-- Farthest Run -->
      <div class="achievement">
        <div class="achievement-body">
          <% distances = [] %>
          <% all_runs.each do |run| %>
            <% if run.date <= Date.today - 1 %>
              <% distance = run.run_distance %>
              <% distances << distance %>
            <% end %>
          <% end %>

          <% if distances == [] %>
            <div class="no-border"></div>
          <% else %>
            <div class="border">
              <h4><%= distances.max %></h4>
              <h5>KILOMETRES</h5>
              <p>FARTHEST RUN</p>
            </div>
          <% end %>
        </div>
        <div class="achievement-footer">

        </div>
      </div>

      <!-- Longest Run -->
      <div class="achievement">
        <div class="achievement-body">
          <% times = [] %>
          <% all_runs.each do |run| %>
            <% if run.date <= Date.today - 1 %>
              <% time_calc = run.run_distance.to_i % run.pace.to_i %>
              <% times << time_calc.to_i %>
            <% end %>
          <% end %>

          <% if times == [] %>
            <div class="no-border">
              <h2><i class="fa fa-meh-o" aria-hidden="true"></i></h2>
            </div>
          <% else %>
            <div class="border">
              <h4><%= times.max %></h4>
              <h5>MINUTES</h5>
              <p>LONGEST RUN</p>
            </div>
          <% end %>
        </div>
        <div class="achievement-footer">
          <%  %>
        </div>
      </div>

      <!-- Fastest Run -->
      <div class="achievement">
        <div class="achievement-body">
          <% paces = [] %>
          <% all_runs.each do |run| %>
            <% if run.date <= Date.today - 1 %>
              <% pace = run.pace %>
              <% paces << pace %>
            <% end %>
          <% end %>

          <% if paces == [] %>
            <div class="no-border"></div>
          <% else %>
            <div class="border">
              <h4><%= paces.min.strftime("%H:%M") %></h4>
              <h5>MIN/KM</h5>
              <p>FASTEST RUN</p>
            </div>
          <% end %>
        </div>
        <div class="achievement-footer">

        </div>
      </div>
    </div>
  </div>
</div>

<%= content_for(:title, "Dashboard") %>

<% content_for(:after_js) do %>
  <script>
    const all = document.getElementById("all-tab");
    all.addEventListener("click", (event) => {
      event.preventDefault();
      $(".content-filter").addClass("hidden")
      $("#all-runs").removeClass("hidden")
    });

    const hosting = document.getElementById("hosting-tab");
    hosting.addEventListener("click", (event) => {
      event.preventDefault();
      $(".content-filter").addClass("hidden")
      $("#hosting-runs").removeClass("hidden")
    });

    const hosted = document.getElementById("hosted-tab");
    hosted.addEventListener("click", (event) => {
      event.preventDefault();
      $(".content-filter").addClass("hidden")
      $("#hosted-runs").removeClass("hidden")
    });

    const upcoming = document.getElementById("upcoming-tab");
    upcoming.addEventListener("click", (event) => {
      event.preventDefault();
      $(".content-filter").addClass("hidden")
      $("#upcoming-runs").removeClass("hidden")
    });

    const past = document.getElementById("past-tab");
    past.addEventListener("click", (event) => {
      event.preventDefault();
      $(".content-filter").addClass("hidden")
      $("#past-runs").removeClass("hidden")
    });
  </script>
<% end %>
